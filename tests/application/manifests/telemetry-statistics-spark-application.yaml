apiVersion: spark.stackable.tech/v1alpha1
kind: SparkApplication
metadata:
  name: pyspark-pi
  namespace: default
spec:
  sparkImage:
    custom: "pulse-telemetry:latest" 
    productVersion: "3.5.1" 
    pullPolicy: IfNotPresent
  mainApplicationFile: local:///pulse-telemetry/src/app/telemetry_statistics.py
  env:
    - name: PULSE_TELEMETRY_CATALOG
      valueFrom:
        configMapKeyRef:
          name: telemetry-statistics-config
          key: PULSE_TELEMETRY_CATALOG
    - name: PULSE_TELEMETRY_DATABASE
      valueFrom:
        configMapKeyRef:
          name: telemetry-statistics-config
          key: PULSE_TELEMETRY_DATABASE
    - name: PULSE_TELEMETRY_WATERMARK_BUFFER
      valueFrom:
        configMapKeyRef:
          name: telemetry-statistics-config
          key: PULSE_TELEMETRY_WATERMARK_BUFFER
    - name: PULSE_TELEMETRY_PARTITION_BUFFER
      valueFrom:
        configMapKeyRef:
          name: telemetry-statistics-config
          key: PULSE_TELEMETRY_PARTITION_BUFFER
  sparkConf:
    spark.sql.extensions: org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions
    spark.sql.catalog.lakehouse: org.apache.iceberg.spark.SparkCatalog
    spark.sql.catalog.lakehouse.type: hive
    spark.sql.catalog.lakehouse.uri: thrift://hive-metastore:9083
    spark.sql.catalog.lakehouse.warehouse: s3a://lakehouse/
    spark.sql.session.timeZone: UTC
  deps:
    packages:
      - org.apache.iceberg:iceberg-spark-runtime-3.5_2.12:1.6.1
      - org.apache.hadoop:hadoop-aws:3.3.4
  mode: cluster
  s3connection:
    reference: minio
  driver:
    config:
      resources:
        cpu:
          min: "1"
          max: "2"
        memory:
          limit: "1Gi"
  executor:
    replicas: 1
    config:
      resources:
        cpu:
          min: "1"
          max: "2"
        memory:
          limit: "1Gi"
